---
title: "Analysis of school drug zone arrests in Connecticut"
author: "Andrew Ba Tran"
output: html_document
---

```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
require(lubridate)
require(stringi)
require(gtools)
require(ggplot2)
require(rgdal)
require(scales)
require(ggmap)
require(dplyr)
require(Cairo)
require(gpclib)
require(stringi)
require(maptools)
library(knitr)
require(tidyr)
require(gridExtra)
gpclibPermit()
gpclibPermitStatus()
tract <- readOGR(dsn="CSPMap", layer="CSPJurisdictions")
towntracts <- readOGR(dsn="townsmap", layer="towns")
raw <- read.csv("sentences.csv")
```

This analysis was used for the story on TrendCT.org based on convictions data from the Connecticut Judicial Branch.

Under current law, a conviction of “Simple Possession” of drugs (21a-279(d)) within 1,500 feet of a school or day care center carries a mandatory minimum two year prison term. A conviction of “Possession with Intent to Sell” (21a-278(b)) drugs within 1,500 feet of a school, day care center, or public housing carries a mandatory minimum three year prison term.

Governor Dannel Malloy has proposed Bill 952 to remove mandatory minimums for the possession of drugs (21a-279(d)) because he states that the two year mandatory prison sentence in urban areas "has had an extraordinarily impact" on African-American and Latino communities. Almost all of the area of New Haven, Hartford, Bridgeport and most other densely populated cities int he state are within a "school zone" while the vast majority of suburban towns are not.

Earlier this month Malloy said 64 percent of those charged with drug possession in school zones are minorities, according to the Sentencing Commission. The Connecticut Judicial Branch could only provide raw data on convictions stretching back to 1999. We looked at data for the following conviction charges:

- 21a-267 (c): Delivering / possessing with intent to deliver / manufacturing with intent to deliver drug paraphernalia.
- 21a-278 (b): Sells / possesses with the intent to sell)1 to another person any controlled substance in or on school / public housing project / licensed child day care center
- 21a-279 (d): Possession of a controlled substance

****
#### Before we begin: our data has `r I(nrow(raw))` rows and `r I(ncol(raw))` columns.
****

## Universal assumptions
- Some races had an extra indication that the convicted was also Hispanic. 
```{r, results='asis'}
hispanic_list <- c("Race", "Hispanic")
hispanic_table <- raw[,hispanic_list]
kable(head(hispanic_table))
```

- Thus if 'Yes' was marked in the Hispanic column, Hispanic overruled the value in the Race column

```{r, results='asis'}
raw$RaceOf <- paste(raw$Race, raw$Hispanic, sep="")
index <- c("", "A", "B", "BY", "C", "CY", "HY")
values <- c("Unlisted", "Asian", "Black", "Hispanic", "White", "Hispanic", "Hispanic")
raw$RaceOfConvicted <- values[match(raw$RaceOf, index)]
```

****

#### What is the overall racial breakdown of drug convictions (c, b, and d combined) since 1999? 

```{r kable}
race_table <- data.frame(table(raw$RaceOfConvicted))
colnames(race_table) <- c("Race", "Convictions")
race_table$Percent <- (race_table$Convictions/sum(race_table$Convictions)*100)
race_table$Percent <- round(race_table$Percent, digits=2)
kable(race_table)
```

#### Simplified to white versus non-white
```{r results='asis', out.width='910px', fig.width=10, fig.height=2, warning=FALSE, message=FALSE, dpi=50}
white_total <- race_table$Percent[5]
minority_total <- sum(race_table$Percent) - white_total
data_versus <- c("White", white_total)
data_versus <- rbind(data_versus, c("Minority", minority_total))
colnames(data_versus) <- c("Race", "Percent")
data_versus <- data.frame(data_versus)
data_versus$Percent <- as.numeric(as.character(data_versus$Percent))
ggplot(data_versus, aes(x=Race, y=Percent, fill=Race)) +
  geom_bar(stat='identity') +
  geom_text(aes(label=Percent), hjust=1) +
  ylab('Percent of convictions') +
  xlab(NULL) +
  theme(
    axis.ticks.y=element_blank(),
    axis.text.y=element_blank()
  ) +
  coord_flip() +
  ggtitle('White and minority convictions since 1999')
```

****

#### What is the racial breakdown by specific charge? 
To simplify, we will refer to 21a-267(c) as Delivering, 21a-278(b) as Selling, and 21a-279(d) as Possessing

```{r results='asis', out.width='910px', fig.width=10, fig.height=2, warning=FALSE, message=FALSE, dpi=50}
convictions_table <- as.data.frame.matrix(table(raw$RaceOfConvicted, raw$Final.Statute))
colnames(convictions_table) <- c("Delivering", "Selling", "Possessing")
kable(convictions_table)
```

#### As a percent of sentences

```{r results='asis', out.width='910px', fig.width=10, fig.height=2, warning=FALSE, message=FALSE, dpi=50}
percent_convictions <- round((convictions_table$Delivering/sum(convictions_table$Delivering))*100, digits=2)
percent_convictions <- data.frame(percent_convictions)
rownames(percent_convictions) <- c("Asian", "Black", "Hispanic", "Unlisted", "White")
percent_convictions$Selling <- round((convictions_table$Selling/sum(convictions_table$Selling))*100, digits=2)
percent_convictions$Possessing <- round((convictions_table$Possessing/sum(convictions_table$Possessing))*100, digits=2)
colnames(percent_convictions) <- c("Delivering Percent", "Selling Percent", "Possessing Percent")
kable(percent_convictions)
```

It looks like convictions for Delivering is almost equal between minorities and whites, but there's a disparity for the other two convictions-- Selling and Possessing.

```{r results='asis', out.width='910px', fig.width=10, fig.height=4, warning=FALSE, message=FALSE, dpi=50}
white_delivering <- percent_convictions$Delivering[5]
white_selling <- percent_convictions$Selling[5]
white_possessing <- percent_convictions$Possessing[5]

minority_delivering <- sum(percent_convictions$Delivering) - white_delivering
minority_selling <- sum(percent_convictions$Selling) - white_selling
minority_possessing <- sum(percent_convictions$Possessing) - white_possessing

data_versus_d <- c("White", white_delivering)
data_versus_d <- rbind(data_versus_d, c("Minority", minority_delivering))
colnames(data_versus_d) <- c("Race", "Percent")
data_versus_d <- data.frame(data_versus_d)
data_versus_d$Percent <- as.numeric(as.character(data_versus_d$Percent))

data_versus_s <- c("White", white_selling)
data_versus_s <- rbind(data_versus_s, c("Minority", minority_selling))
colnames(data_versus_s) <- c("Race", "Percent")
data_versus_s <- data.frame(data_versus_s)
data_versus_s$Percent <- as.numeric(as.character(data_versus_s$Percent))

data_versus_p <- c("White", white_possessing)
data_versus_p <- rbind(data_versus_p, c("Minority", minority_possessing))
colnames(data_versus_p) <- c("Race", "Percent")
data_versus_p <- data.frame(data_versus_p)
data_versus_p$Percent <- as.numeric(as.character(data_versus_p$Percent))


d_plot <- ggplot(data_versus_d, aes(x=Race, y=Percent, fill=Race)) +
  geom_bar(stat='identity') +
  geom_text(aes(label=Percent), vjust=1) +
  ylab('Percent of convictions') +
  xlab(NULL) +
  expand_limits(y=c(0,100)) +
  theme(
    axis.ticks.y=element_blank(),
    axis.text.y=element_blank()
  ) +
  ggtitle('Delivering')

s_plot <- ggplot(data_versus_s, aes(x=Race, y=Percent, fill=Race)) +
  geom_bar(stat='identity') +
  geom_text(aes(label=Percent), vjust=1) +
  ylab('Percent of convictions') +
  xlab(NULL) +
  expand_limits(y=c(0,100)) +
  theme(
    axis.ticks.y=element_blank(),
    axis.text.y=element_blank()
  ) +
  ggtitle('Selling')

p_plot <- ggplot(data_versus_p, aes(x=Race, y=Percent, fill=Race)) +
  geom_bar(stat='identity') +
  geom_text(aes(label=Percent), vjust=1) +
  ylab('Percent of convictions') +
  xlab(NULL) +
  expand_limits(y=c(0,100)) +
  theme(
    axis.ticks.y=element_blank(),
    axis.text.y=element_blank()
  ) +
  ggtitle('Possessing')

grid.arrange(d_plot, s_plot, p_plot, ncol=3)
#qplot(Charge, data=convictions_table2, geom="bar", fill=Race)
```

#### Which town police departments lead to the most convictions?

```{r results='asis'}
# Subset based on arresting agency
juris_conv <- data.frame(table(raw$Police.Name))
colnames(juris_conv) <- c("Department", "Convictions.Total")
juris_conv <- juris_conv[order(-juris_conv$Convictions.Total),]

# subset out town police departments vs the rest
towns_only <- juris_conv[grepl("LOCAL POLICE", juris_conv$Department),]
not_towns <- juris_conv[grep("LOCAL POLICE", juris_conv$Department, invert=TRUE),]

csp_only <- juris_conv[grepl("CSP TROOP", juris_conv$Department),]
csp_only$Department <- as.character(csp_only$Department)
csp_only$Department <- gsub("CSP TROOP ", "", csp_only$Department)
colnames(csp_only) <- c("id", "Convictions")

towns_only$Department <- as.character(towns_only$Department)
towns_only$Department <- gsub("LOCAL POLICE ", "", towns_only$Department)
colnames(towns_only) <- c("id", "Convictions")
ownpop <- read.csv("townsmap/townpopulation.csv")
colnames(townpop) <- c("id","Population")
townpop$id <- toupper(townpop$id)

towns_only <- left_join(townpop, towns_only)
towns_only$Convictions [is.na(towns_only$Convictions)] <-0
towns_only$id <- stri_trans_general(towns_only$id, id="Title")
towns_only$Per10kResidents <- (towns_only$Convictions/towns_only$Population)*10000
towns_only$Per10kResidents <- round(towns_only$Per10kResidents, digits=2)
towns_only <- towns_only[order(-towns_only$Per10kResidents),]
kable(head(towns_only,10))
```
```{r results='asis', out.width='910px', fig.width=10, fig.height=4, warning=FALSE, message=FALSE, dpi=50}
towntracts <- fortify(towntracts, region="NAME10")
townData <- left_join(towntracts, towns_only)

p2 <- ggplot() +
  geom_polygon(data = townData, aes(x=long, y=lat, group=group, 
                                    fill=Per10kResidents), color = "black", size=0.2) +
  coord_map() +
  scale_fill_distiller(type="seq", palette = "Greens", breaks=pretty_breaks(n=5)) +
  theme_nothing(legend=TRUE) +
  labs(title="Convictions from city police departments per 10,000 residents", fill="")
p2
```

#### What about non-town police departments?
```{r results='asis', out.width='910px', fig.width=10, fig.height=4, warning=FALSE, message=FALSE, dpi=50}
not_towns <- juris_conv[grep("LOCAL POLICE", juris_conv$Department, invert=TRUE),]
not_towns <- not_towns[order(-not_towns$Convictions),]
kable(head(not_towns))

csp_only <- juris_conv[grepl("CSP TROOP", juris_conv$Department),]
csp_only$Department <- as.character(csp_only$Department)
csp_only$Department <- gsub("CSP TROOP ", "", csp_only$Department)
colnames(csp_only) <- c("id", "Convictions")

tract <- fortify(tract, region="Troop")

plotData <- left_join(tract, csp_only)

p <- ggplot() +
  geom_polygon(data = plotData, aes(x=long, y=lat, group=group, 
                                    fill=Convictions), color = "black", size=0.25) +
  coord_map() +
  scale_fill_distiller(palette = "Greens",
                       breaks = pretty_breaks(n = 10)) +
  theme_nothing(legend=TRUE) +
  labs(title="Number of convictions from Connecticut State Troopers", fill="")
p
```

